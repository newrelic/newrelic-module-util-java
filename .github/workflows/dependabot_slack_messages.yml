name: Dependabot High/Critical Slack Notification

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
    contents: read
    security-events: read

jobs:
  # this job is responsible for checking Dependabot alerts for high and critical vulnerabilities and comparing them to
  # the alerts from the previous run. It then saves the new alerts to the output.
  check-dependabot-alerts:
    runs-on: ubuntu-latest
    outputs:
      new_alerts: ${{ steps.check-new-alerts.outputs.new_alerts }}
    steps:
      # Fetch Dependabot alerts for high and critical vulnerabilities only
      - name: Fetch Dependabot Alerts
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # pin@v7.0.1
        id: get-alerts
        with:
          script: |
            const response = await github.request('GET /repos/{owner}/{repo}/dependabot/alerts', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              severity: 'high,critical',
              state: 'open'
            });

            const now = new Date();
            const last24 = new Date(now - 24 * 60 * 60 * 1000);

            const recentAlerts = response.data.filter(alert => {
              const createdAt = new Date(alert.created_at);
              return createdAt > last24;
            }).map(alert => ({
              number: alert.number,
              severity: alert.security_advisory.severity,
              link: alert.html_url
            }));

            return JSON.stringify(recentAlerts);

      # Save alerts to the alerts.json file
      - name: Save Alerts to File
        id: save-alerts
        run: echo "${{ steps.get-alerts.outputs.result }}" > alerts.json

      # compare the values in old_alerts and new_alerts to get only the new alerts and save them in only_new_alerts,
      # then save it to the output
      - name: Check for New High/Critical Alerts
        id: check-new-alerts
        run: |
          new_alerts=$(cat alerts.json)
          echo "new_alerts=$new_alerts" >> $GITHUB_OUTPUT

      # !!! REMOVE AFTER TESTING (MANUALLY TRIGGERING WORKFLOW) !!!
      - name: Send Test Message to Slack Channel (Workflow Dispatch Only)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          SLACK_DEPENDABOT_TOKEN: ${{ secrets.SLACK_DEPENDABOT_TOKEN }}
        run: |
          for alert in $(echo '${{ steps.check-new-alerts.outputs.new_alerts }}' | jq -c '.[]'); do
            alert_number="test-1234"
            alert_severity="High"
            alert_link="https://github.com"

            payload=$(
              jq -n \
                --arg alert_number "$alert_number" \
                --arg alert_severity "$alert_severity" \
                --arg alert_link "$alert_link" \
                '{
                  "text": ":rotating_light: *--Testing High/Critical Dependabot Alerts*",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "• *Alert Number:* \($alert_number)\n• *Severity:* \($alert_severity)\n• <\($alert_link)|*View Alert*>"
                      }
                    }
                  ]
                }'
            )

            echo "$payload" | slackapi/slack_github_action@slackapi/slack-github-action@60a0d83039c74a4aee543508d2ffcb1c3799cdea --token $SLACK_BOT_TOKEN
          done

  # this job is responsible for sending Slack notifications for each new alert in the new_alerts output
  send-slack-notifications:
    needs: check-dependabot-alerts
    if: ${{ needs.check-dependabot-alerts.outputs.new_alerts != '[]'}}
    runs-on: ubuntu-latest
    steps:
      # Send a Slack notification for each new alert in the new_alerts output
      - name: Send Slack Notification
        env:
          SLACK_DEPENDABOT_TOKEN: ${{ secrets.SLACK_DEPENDABOT_TOKEN }}
        run: |
          for alert in $(echo '${{ needs.check-dependabot-alerts.outputs.new_alerts }}' | jq -c '.[]'); do
            alert_number=$(echo "$alert" | jq -r '.number')
            alert_severity=$(echo "$alert" | jq -r '.severity')
            alert_link=$(echo "$alert" | jq -r '.link')

            payload=$(
              jq -n \
                --arg alert_number "$alert_number" \
                --arg alert_severity "$alert_severity" \
                --arg alert_link "$alert_link" \
                '{
                  "text": ":rotating_light: *New High/Critical Dependabot Alert Reported*",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "• *Alert Number:* \($alert_number)\n• *Severity:* \($alert_severity)\n• <\($alert_link)|*View Alert*>"
                      }
                    }
                  ]
                }'
            )

            echo "$payload" | slackapi/slack-github-action@60a0d83039c74a4aee543508d2ffcb1c3799cdea --token $SLACK_BOT_TOKEN
          done
